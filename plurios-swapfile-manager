#!/bin/bash
# Author: @FershoUno
# Translation code made by crims0n from the MiniOS installer project

function check_root(){
    if [[ $EUID -ne 0 ]]; then
        pkexec "$0"
        exit 0
    fi
}

function translate() {
    local TEXT=$1
    if [ ! -f plurios-release ]; then
        local LNG=$(locale | grep LANG | cut -d= -f2 | cut -d_ -f1)
    else
        if grep -q Pro plurios-release ; then
        LNG=es
        elif grep -q Aymara plurios-release ; then
        LNG=ay
        fi
    fi
    local TRANSLATION_FILE="translate/$LNG.json"
    if [ -f "$TRANSLATION_FILE" ]; then
        local TRANSLATION=$(jq -r --arg TEXT "$TEXT" '.[$TEXT]' "$TRANSLATION_FILE")
        if [ "$TRANSLATION" != "null" ]; then
            echo $TRANSLATION
        else
            echo $TEXT
        fi
    else
        echo $TEXT
    fi
}

function detect_swapfile() {
    local NAME="/swapfile"
    if grep -q $NAME /etc/fstab && [[ -f $NAME ]]; then
        MESSAGE_SWAP=$(echo "$(translate 'Swapfile detected:') $NAME")
        MESSAGE_TEXT=$(echo "$(translate 'It is possible to manage this type of swap.')")
        menu_swapfile
    fi
    MESSAGE_SWAP="echo $(translate 'Swapfile not detected:')"
    MESSAGE_TEXT=$(echo "$(translate 'No active swap found.')")
    menu_exit
}

function swapfile_status(){
    SWAPFILE_SIZE=$(swapon --show NAME,USER --noheadings | grep /swapfile | awk '{print 3}')
    SWAPFILE_USED=$(swapon --show NAME,USER --noheadings | grep /swapfile | awk '{print $4}')
}

function swapfile_generator(){
    local SWAPFILE="/swapfile"
    swapoff $SWAPFILE
    rm -f $SWAPFILE
    fallocate -l $SWAPFILE_SIZE $SWAPFILE
    chmod 600 $SWAPFILE
    mkswap $SWAPFILE
    swapon $SWAPFILE
}

function menu_swapfile(){
    yad --window-icon "ubiquity" \
    --borders=15 \
    --width=300 \
    --height=100 \
    --image "dialog-question" \
    --title "$(translate 'Swapfile Manager')"
}

function alert_noswap(){
    detect_the_swap_type
yad --window-icon "ubiquity" \
    --borders=15 \
    --width=300 \
    --height=100 \
    --image "dialog-question" \
	--title "$(translate 'Alert')" \
	--text "$MESSAGE_SWAP\n$MESSAGE_TEXT" \
	--button="$(translate 'Add')!gtk-add":0 \
	--button="$(translate 'Cancel')!gtk-cancel":1 \
	option=$?

[[ $option -eq 0 ]] && echo "$(translate 'Creating SWAPFILE')"
[[ $option -eq 1 ]] && echo "$(translate 'Exit')"
}

function main_menu(){
MAIN_MENU=$(yad --title="PluriOS Swapfile Manager" \
    --borders=10 \
    --text="<span font-size=\"large\">Mensaje de ayuda para la swapfile</span>" \
    --form \
    --field="Botón 1:FBTN" "" \
    --field="Botón 2:FBTN" "" \
    --field="Botón 3:FBTN" "" \
    --columns=3 \
    --button="Aplicar":0 \
    --button="Salir":1 \
    --width=400 
    )
}


#check_root
#alert_noswap
main_menu